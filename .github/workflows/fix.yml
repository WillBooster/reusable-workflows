name: Fix

on:
  workflow_call:

jobs:
  test:
    runs-on: self-hosted
    steps:
      - name: Check version files
        id: check-ver
        run: |
          if [[ -f .tool-versions || -f .node-version || -f .python-version ]]; then
            echo "exist-any-version=1" >> $GITHUB_OUTPUT
          fi
          if [[ -f .node-version || "$(cat .tool-versions)" == *'nodejs'* ]]; then
            echo "exist-nodejs-version=1" >> $GITHUB_OUTPUT
          fi
      - if: ${{ !steps.check-ver.outputs.exist-nodejs-version }}
        uses: actions/setup-node@v4
        with:
          check-latest: true
      - if: ${{ steps.check-ver.outputs.exist-any-version }}
        uses: willbooster/asdf-actions/install@main
      - name: Show environment information
        id: env-info
        # https://stackoverflow.com/a/677212
        run: |
          if [[ -f bunfig.toml ]] && grep -q bun .tool-versions; then
            echo "bun: $(bun -v)"
            echo "runner=bun" >> $GITHUB_OUTPUT
          else
            YARN=$(yarn -v); echo "yarn: $YARN"
            if [[ "$YARN" == "1."* ]]; then
              echo "yarn-dir=$(yarn cache dir)" >> $GITHUB_OUTPUT
            fi
            echo "runner=yarn" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          if [[ "${{ steps.env-info.outputs.runner }}" == "bun" ]]; then
            # Because bun sometimes fails to install private repos (but, update is okay)
            bun update --no-save
          else
            ${{ steps.env-info.outputs.runner }} install || true # To ignore postinstall errors
          fi
      - name: Fix code
        run: |
          if grep -q '"gen-code":' package.json; then
            ${{ steps.env-info.outputs.runner }} run gen-code
          fi
          if grep -q '"cleanup":' package.json; then
            ${{ steps.env-info.outputs.runner }} run cleanup
          elif grep -q '"lint-fix":' package.json; then
            ${{ steps.env-info.outputs.runner }} run lint-fix
          elif grep -q '"lint":' package.json; then
            ${{ steps.env-info.outputs.runner }} run lint
          fi
          if grep -q '"build/ci":' package.json; then
            ${{ steps.env-info.outputs.runner }} run build/ci
          elif grep -q '"build":' package.json; then
            ${{ steps.env-info.outputs.runner }} run build
          fi
          if git status | grep -q "Changes not staged for commit"; then
            git status
            git diff
            echo "Found changes during gen-code, lint-fix and/or build"
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              rm -Rf **/.next
              git stash
              git fetch origin ${{ github.head_ref }}
              git switch ${{ github.head_ref }}
              git stash pop
              git config --global user.email "bot@willbooster.com"
              git config --global user.name "WillBooster Inc."
              git add -A
              git commit -m "fix: apply changes by lint-fix and build" -a
              git push origin ${{ github.head_ref }}
            fi
            exit 1
          fi
